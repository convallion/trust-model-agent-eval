"""initial_schema

Revision ID: 7546b95f09b9
Revises: 
Create Date: 2026-01-10 08:25:40.777887

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '7546b95f09b9'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('organizations',
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('agents',
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('agent_type', sa.String(length=50), nullable=False),
    sa.Column('framework', sa.String(length=100), nullable=True, comment='Agent framework (e.g., LangChain, AutoGen, Claude Code)'),
    sa.Column('version', sa.String(length=50), nullable=True, comment='Agent version string'),
    sa.Column('status', sa.String(length=20), nullable=False),
    sa.Column('agent_metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('declared_capabilities', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('organization_id', sa.UUID(), nullable=False),
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_agents_name'), 'agents', ['name'], unique=False)
    op.create_table('users',
    sa.Column('email', sa.String(length=255), nullable=False),
    sa.Column('hashed_password', sa.String(length=255), nullable=False),
    sa.Column('full_name', sa.String(length=255), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('is_superuser', sa.Boolean(), nullable=False),
    sa.Column('organization_id', sa.UUID(), nullable=True),
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    op.create_table('api_keys',
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('key_hash', sa.String(length=255), nullable=False),
    sa.Column('key_prefix', sa.String(length=20), nullable=False, comment='First few chars of key for identification'),
    sa.Column('scopes', postgresql.ARRAY(sa.String()), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('last_used_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('evaluation_runs',
    sa.Column('agent_id', sa.UUID(), nullable=False),
    sa.Column('status', sa.String(length=20), nullable=False),
    sa.Column('suites', postgresql.ARRAY(sa.String()), nullable=False, comment='Evaluation suites to run (capability, safety, reliability, communication)'),
    sa.Column('config', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Evaluation configuration (trials_per_task, parallel, timeout, etc.)'),
    sa.Column('started_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('overall_score', sa.Numeric(precision=5, scale=2), nullable=True, comment='Overall score 0-100'),
    sa.Column('grade', sa.String(length=1), nullable=True),
    sa.Column('certificate_eligible', sa.Boolean(), nullable=False, comment='Whether agent is eligible for certification'),
    sa.Column('capability_score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('safety_score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('reliability_score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('communication_score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('results', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Detailed results per suite and test'),
    sa.Column('error_message', sa.String(length=1000), nullable=True),
    sa.Column('progress_percent', sa.Integer(), nullable=False),
    sa.Column('current_suite', sa.String(length=50), nullable=True),
    sa.Column('current_test', sa.String(length=255), nullable=True),
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['agent_id'], ['agents.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_evaluation_runs_agent_id'), 'evaluation_runs', ['agent_id'], unique=False)
    op.create_table('tacp_sessions',
    sa.Column('initiator_agent_id', sa.UUID(), nullable=False),
    sa.Column('responder_agent_id', sa.UUID(), nullable=False),
    sa.Column('initiator_certificate_id', sa.UUID(), nullable=True),
    sa.Column('responder_certificate_id', sa.UUID(), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=False),
    sa.Column('purpose', sa.Text(), nullable=True, comment='Purpose of this session'),
    sa.Column('scope', sa.Text(), nullable=True, comment='Agreed scope of collaboration'),
    sa.Column('constraints', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Session constraints (max_duration, max_messages, data_classification)'),
    sa.Column('initiator_capabilities', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('responder_capabilities', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('agreed_capabilities', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Capabilities agreed upon for this session'),
    sa.Column('established_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('ended_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('end_reason', sa.String(length=50), nullable=True, comment='Reason for session end (completed, timeout, error, user_cancelled)'),
    sa.Column('message_count', sa.Integer(), nullable=False),
    sa.Column('task_count', sa.Integer(), nullable=False),
    sa.Column('audit_log', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Audit log of significant session events'),
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['initiator_agent_id'], ['agents.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['responder_agent_id'], ['agents.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_tacp_sessions_initiator_agent_id'), 'tacp_sessions', ['initiator_agent_id'], unique=False)
    op.create_index(op.f('ix_tacp_sessions_responder_agent_id'), 'tacp_sessions', ['responder_agent_id'], unique=False)
    op.create_index(op.f('ix_tacp_sessions_status'), 'tacp_sessions', ['status'], unique=False)
    op.create_table('traces',
    sa.Column('agent_id', sa.UUID(), nullable=False),
    sa.Column('session_id', sa.String(length=255), nullable=True, comment='External session identifier'),
    sa.Column('task_description', sa.Text(), nullable=True, comment='Human-readable task description'),
    sa.Column('started_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('ended_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('total_tokens', sa.Integer(), nullable=False),
    sa.Column('total_cost_usd', sa.Float(), nullable=True),
    sa.Column('tool_call_count', sa.Integer(), nullable=False),
    sa.Column('trace_metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['agent_id'], ['agents.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_traces_agent_id'), 'traces', ['agent_id'], unique=False)
    op.create_index(op.f('ix_traces_session_id'), 'traces', ['session_id'], unique=False)
    op.create_table('certificates',
    sa.Column('version', sa.String(length=10), nullable=False),
    sa.Column('agent_id', sa.UUID(), nullable=False),
    sa.Column('evaluation_id', sa.UUID(), nullable=False),
    sa.Column('status', sa.String(length=20), nullable=False),
    sa.Column('issued_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('grade', sa.String(length=1), nullable=False),
    sa.Column('overall_score', sa.Numeric(precision=5, scale=2), nullable=False),
    sa.Column('capability_score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('safety_score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('reliability_score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('communication_score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('certified_capabilities', postgresql.ARRAY(sa.String()), nullable=False, comment='Capabilities this agent is certified for'),
    sa.Column('not_certified', postgresql.ARRAY(sa.String()), nullable=False, comment='Explicitly NOT certified for these capabilities'),
    sa.Column('safety_attestations', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='List of safety attestations with test counts and pass rates'),
    sa.Column('signature', sa.Text(), nullable=False, comment='Ed25519 signature of certificate data'),
    sa.Column('issuer_certificate_id', sa.UUID(), nullable=True, comment='ID of the issuing CA certificate (for chain of trust)'),
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['agent_id'], ['agents.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['evaluation_id'], ['evaluation_runs.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_certificates_agent_id'), 'certificates', ['agent_id'], unique=False)
    op.create_index(op.f('ix_certificates_status'), 'certificates', ['status'], unique=False)
    op.create_table('spans',
    sa.Column('trace_id', sa.UUID(), nullable=False),
    sa.Column('parent_span_id', sa.UUID(), nullable=True),
    sa.Column('span_type', sa.String(length=50), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('started_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('ended_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=False),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('attributes', postgresql.JSONB(astext_type=sa.Text()), nullable=False, comment='Span-specific attributes (e.g., model, tokens for LLM calls)'),
    sa.Column('id', sa.UUID(), nullable=False),
    sa.ForeignKeyConstraint(['parent_span_id'], ['spans.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['trace_id'], ['traces.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_spans_trace_id'), 'spans', ['trace_id'], unique=False)
    op.create_table('revocations',
    sa.Column('certificate_id', sa.UUID(), nullable=False),
    sa.Column('reason', sa.Text(), nullable=False),
    sa.Column('revoked_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('revoked_by', sa.UUID(), nullable=True, comment='User ID who initiated the revocation'),
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['certificate_id'], ['certificates.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('certificate_id')
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('revocations')
    op.drop_index(op.f('ix_spans_trace_id'), table_name='spans')
    op.drop_table('spans')
    op.drop_index(op.f('ix_certificates_status'), table_name='certificates')
    op.drop_index(op.f('ix_certificates_agent_id'), table_name='certificates')
    op.drop_table('certificates')
    op.drop_index(op.f('ix_traces_session_id'), table_name='traces')
    op.drop_index(op.f('ix_traces_agent_id'), table_name='traces')
    op.drop_table('traces')
    op.drop_index(op.f('ix_tacp_sessions_status'), table_name='tacp_sessions')
    op.drop_index(op.f('ix_tacp_sessions_responder_agent_id'), table_name='tacp_sessions')
    op.drop_index(op.f('ix_tacp_sessions_initiator_agent_id'), table_name='tacp_sessions')
    op.drop_table('tacp_sessions')
    op.drop_index(op.f('ix_evaluation_runs_agent_id'), table_name='evaluation_runs')
    op.drop_table('evaluation_runs')
    op.drop_table('api_keys')
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_table('users')
    op.drop_index(op.f('ix_agents_name'), table_name='agents')
    op.drop_table('agents')
    op.drop_table('organizations')
    # ### end Alembic commands ###
